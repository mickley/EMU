---
title: "Microenvironmental Differences Within Transects"
author: "James Mickley"
output:
  html_document:
    keep_md: yes
    theme: readable
    toc: yes
  html_notebook:
    theme: readable
graphics: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include = F}
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Knitr Options
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Set root directory to the project directory
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())


# Set default knitr options: 
# Suppress warnings and messages, cache chunks, 
#  set default figure size to 6x8 at 300 dpi, and save a png and pdf
knitr::opts_chunk$set(warning = F, message = F, collapse = T, cache = T,
    fig.height = 6, fig.width = 8, dpi = 300, # 6x8" @ 300dpi:1800x2400=4.3MP
    dev = c('png', 'pdf'), dev.args = list(pdf = list(onefile = F)))

```



## Overview

This analysis is looking for microenvironmental differences or gradients within transects.

We're using this [GAM approach](http://www.fromthebottomoftheheap.net/2014/05/09/modelling-seasonal-data-with-gam/).  In this approach, there are two smoothers.  One smoother is a cubic spline that accounts for intra-day variation.  Then a second spline is fitted to account for temporal variation that is not intra-day.  

Readings have temporal autocorrelation, therefore, we add an autoregressive moving average correlation structure (corAR1). We set the form here to account for autocorrelation separately for each transect position, treating positions as independent.  In every case, accounting for autocorrelation improves the models considerably, however, some autocorrelation is still unaccounted for.  Zuur et. al. say that it's usually not worth finding the optimal autocorrelation structure.  

After all temporal effects are accounted for, we test for differences among transect positions separately for each transect (woods and meadow) and each variable (temperature, humidity, vwc, pfd).

We do this with two models: in one the transect positions are treated as individual factors, and there is no explicit spatial trend.  In the other, transect positions are treated as a continuous variable, testing for a gradient.

**Expectations:**

1. The woods VWC should increase (wetter) from 1 to 4, moving down the hill (no, but heterogeneity)
2. The meadow VWC should increase (wetter) from 1 to 4, moving into the swamp (yes)
3. The woods temperature should get cooler from 1 to 4, moving down the hill (no)
4. There should be no difference in PFD, or in temperature @ the meadow
    1. In fact, there are slight gradients in PFD in both sites, especially the meadow
    2. No differences in temp at the meadow
5. Humidity is unclear, but perhaps it would mirror soil moisture patterns
    1. No gradient, but some heterogeneity (in the meadow)


#### Transects

* Meadow: 1 (dry, sunny, grassy) to 4 (wet, some shade from ferns and shrubs)
* Woods: 1 (highest part of hill, but not top) to 4 (bottom of hill)



```{r 'Main_Code', include = F, cache = F}

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Setup - This code is run, but output is hidden
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Load Packages
require(cowplot) # Needed for publication-quality ggplots
require(tidyverse) # Needed for data wrangling
require(lubridate) # Needed for date wrangling
require(mgcv) # Needed for gams
require(bbmle) # Needed for AICc
require(rgeos) # Required for dawn/dusk times
require(maptools) # Required for dawn/dusk times

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Data Preparation
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Import datasets
data <- read.csv("Data/EMU-6-21/fentondata-all.csv")


# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ ggPlot Theme
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

ggplot.theme <- theme(
    
    # Text size for axis ticks
    axis.text.y = element_text(size = 14),
    axis.text.x = element_text(size = 14),
    
    # Text size for axis labels
    # Also move them away from the axes a bit for more space
    axis.title.x = element_text(size = 18, face = "bold", vjust = -1),
    axis.title.y = element_text(size = 18, face = "bold", vjust = 1.5),
    
    # Plot title size
    plot.title = element_text(size = 20, face = "bold"),
    
    # Margins for top, right, bottom, left
    plot.margin = grid::unit(c(1.5, 1.5, 1.5, 1.2), "lines"), 
    
    # Legend text size
    legend.text = element_text(size = 14),
    legend.text.align = 0, 
    legend.title = element_text(size = 16, face = "bold"),
    legend.key.size = grid::unit(1.4, "line"),
    legend.key = element_blank()
    )


```



```{r 'Data_Wrangling', echo = F, include = F}


# Data wrangling on the main dataset
fenton <- data %>%
    
    # Convert the timestamp to a date/time object
    mutate(timestamp = as.POSIXct(timestamp)) %>%
    
    # Remove the seconds from the time, leaving only hour/minute
    mutate(timestamp = timestamp - second(timestamp))

# Take a look at the structure of the main dataset
#str(fenton)


#### Temperature #####


# Make a dataset for the meadow EMU temperatures
m.temp.data <- fenton %>%

    # Filter only EMU data with a temperature from the meadow
    filter(source == "EMU", !is.na(temperature), transect == "Meadow", order != 1)
    

# Make a dataset for the woods EMU temperatures
w.temp.data <- fenton %>%

    # Filter only EMU data with a temperature from the meadow
    filter(source == "EMU", !is.na(temperature), transect == "Woods")



#### Humidity #####


# Make a dataset for the meadow EMU humidity
m.humid.data <- fenton %>%

    # Filter only EMU data with a humidity from the meadow
    filter(source == "EMU", !is.na(humidity), humidity > 0, 
        transect == "Meadow", order != 1)


# Make a dataset for the woods EMU humidity
w.humid.data <- fenton %>%

    # Filter only EMU data with a humidity from the meadow
    filter(source == "EMU", !is.na(humidity), humidity > 0, 
        transect == "Woods")


#### VWC #####


# Make a dataset for the meadow EMU vwc
m.vwc.data <- fenton %>%

    # Filter only EMU data with a vwc from the meadow
    filter(source == "EMU", !is.na(vwc), transect == "Meadow")


# Make a dataset for the woods EMU vwc
w.vwc.data <- fenton %>%

    # Filter only EMU data with a vwc from the meadow
    filter(source == "EMU", !is.na(vwc), transect == "Woods") 


#### PFD #####


# Make a dataset for the meadow EMU pfd
m.pfd.data <- fenton %>%

    # Filter only EMU data with a pfd from the meadow
    filter(source == "EMU", !is.na(pfd), transect == "Meadow")


# Make a dataset for the woods EMU pfd
w.pfd.data <- fenton %>%

    # Filter only EMU data with a pfd from the meadow
    filter(source == "EMU", !is.na(pfd), transect == "Woods")


# Dawn/Dusk times dataset
# See: http://rstudio-pubs-static.s3.amazonaws.com/17282_9510673f07294de7905e11c7f2b043a5.html

# Create a coordinate for the Fenton site
fenton.coord <- matrix(c(-72.238159, 41.825076), nrow = 1) %>%
    SpatialPoints(proj4string = CRS("+proj=longlat +datum=WGS84"))

# Create a data frame with dawn and dusk times with the following start/end dates for the project
darkness <- data.frame(date = seq(from = as.POSIXct("2017-05-30"), 
     to = as.POSIXct("2017-06-21"), by = "day")) %>%
     
     # Add dawn times
     mutate(dawn.time = crepuscule(fenton.coord, date, solarDep = 6, 
         direction = "dawn", POSIXct.out = TRUE)$time) %>%
  
     # Add dusk times
     mutate(dusk.time = crepuscule(fenton.coord, date, solarDep = 6, 
         direction = "dusk", POSIXct.out = TRUE)$time) %>%
    
     # Convert dawn and dusk times to hours since the start
     mutate(
         dusk = round(interval(as.POSIXct("2017-05-30 12:00"), lag(dusk.time)) /
            dhours(1)),
         dawn = round(interval(as.POSIXct("2017-05-30 12:00"), dawn.time) /
            dhours(1))) %>%
    
    # Get rid of the first day
    filter(date >= as.POSIXct("2017-05-31"))

```


## Temperature


### Meadow Temperature

The model that includes transect order is worse than the base temporal model for meadow temperature.

There are no significant differences between position 2, 3, and 4 (1 is bad data and removed).  The maximum difference is 0.65 ยบC between positions.

**NOTE:** Position two is the reference level for this model: the intercept is the temperature for position 2.

```{r 'Meadow_Temp', echo = F, comment = ""}

# Construct an uncorrelated gam with the two smoothers
m.temp.uncorr <- gamm(temperature ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = m.temp.data)

##### Autocorrelation #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(m.temp.uncorr$lme), lag.max = 96, main = "ACF")
pacf(resid(m.temp.uncorr$lme), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# ARMA Coefficients (non negative, default = 0)
# p = autoregressive order
# q = moving average order

# p = 1, q = 0 (AR1), grouped by order
m.temp.ar1 <- gamm(temperature ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = m.temp.data,
    correlation = corAR1(form = ~ 1|order))

# Compare models
AICctab(m.temp.uncorr$lme, m.temp.ar1$lme, nobs = nrow(m.temp.data))

# Show model summary
summary(m.temp.ar1$gam)

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(m.temp.ar1$lme, type = "normalized"), lag.max = 96, main = "ACF")
pacf(resid(m.temp.ar1$lme, type = "normalized"), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# Plot residuals over time
plot(m.temp.ar1$lme, resid(., type = "normalized") ~ minute)



##### Model Temporal Fit #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# Plot the two smoothers
plot(m.temp.ar1$gam, shade = T, residuals = T, ylab = "Temperature (ยบ C)", 
    main = "Meadow Temp")

# Reset the layout
layout(1)


##### Transect Order #####

# Fit a model with transect order as a factor
m.temp.ar1.factor <- gamm(temperature ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + factor(order), 
    data = m.temp.data, correlation = corAR1(form = ~ 1|order))

# Fit a model with continuous transect order
m.temp.ar1.continuous <- gamm(temperature ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + order, 
    data = m.temp.data, correlation = corAR1(form = ~ 1|order))

# Test whether there are differences in temperature along the transect
AICctab(m.temp.uncorr$lme, m.temp.ar1$lme, m.temp.ar1.factor$lme, 
    m.temp.ar1.continuous$lme, nobs = nrow(m.temp.data))

# Show the summary for the transect order
summary(m.temp.ar1.factor$gam)
summary(m.temp.ar1.factor$lme)


```

### Woods Temperature

The model that includes transect order is worse than the base temporal model for woods temperature.

There are no significant differences between any of the positions relative to position 1, and a maximum difference of 0.48 ยบC between positions.

```{r 'Woods_Temp', echo = F, comment = ""}

# Construct an uncorrelated gam with the two smoothers
w.temp.uncorr <- gamm(temperature ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = w.temp.data)

##### Autocorrelation #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(w.temp.uncorr$lme), lag.max = 96, main = "ACF")
pacf(resid(w.temp.uncorr$lme), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# ARMA Coefficients (non negative, default = 0)
# p = autoregressive order
# q = moving average order

# p = 1, q = 0 (AR1), grouped by order
w.temp.ar1 <- gamm(temperature ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = w.temp.data,
    correlation = corAR1(form = ~ 1|order))

# Compare models
AICctab(w.temp.uncorr$lme, w.temp.ar1$lme, nobs = nrow(w.temp.data))

# Show model summary
summary(w.temp.ar1$gam)

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(w.temp.ar1$lme, type = "normalized"), lag.max = 96, main = "ACF")
pacf(resid(w.temp.ar1$lme, type = "normalized"), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# Plot residuals over time
plot(w.temp.ar1$lme, resid(., type = "normalized") ~ minute)


##### Model Temporal Fit #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# Plot the two smoothers
plot(w.temp.ar1$gam, shade = T, residuals = T, ylab = "Temperature (ยบ C)", main = "Woods Temp")

# Reset the layout
layout(1)

##### Transect Order #####

# Fit a model with transect order as a factor
w.temp.ar1.factor <- gamm(temperature ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + factor(order), 
    data = w.temp.data, correlation = corAR1(form = ~ 1|order))

# Fit a model with continuous transect order
w.temp.ar1.continuous <- gamm(temperature ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + order, 
    data = w.temp.data, correlation = corAR1(form = ~ 1|order))

# Test whether there are differences in temperature along the transect
AICctab(w.temp.uncorr$lme, w.temp.ar1$lme, w.temp.ar1.factor$lme, 
    w.temp.ar1.continuous$lme, nobs = nrow(w.temp.data))

# Show the summary for the transect order
summary(w.temp.ar1.factor$gam)
summary(w.temp.ar1.factor$lme)


```


## Humidity

### Meadow Humidity

The model that includes transect order is better than the base temporal model for meadow humidity.

There are no significant differences between position 2 and 3, but position 4 is 7.9% more humid.  This would make sense, given its position in the swamp.

```{r 'Meadow_Humid', echo = F, comment = ""}

# Construct an uncorrelated gam with the two smoothers
m.humid.uncorr <- gamm(humidity ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = m.humid.data)

##### Autocorrelation #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(m.humid.uncorr$lme), lag.max = 96, main = "ACF")
pacf(resid(m.humid.uncorr$lme), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# ARMA Coefficients (non negative, default = 0)
# p = autoregressive order
# q = moving average order

# p = 1, q = 0 (AR1), grouped by order
m.humid.ar1 <- gamm(humidity ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = m.humid.data,
    correlation = corAR1(form = ~ 1|order))

# Compare models
AICctab(m.humid.uncorr$lme, m.humid.ar1$lme, nobs = nrow(m.humid.data))

# Show model summary
summary(m.humid.ar1$gam)

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(m.humid.ar1$lme, type = "normalized"), lag.max = 96, main = "ACF")
pacf(resid(m.humid.ar1$lme, type = "normalized"), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# Plot residuals over time
plot(m.humid.ar1$lme, resid(., type = "normalized") ~ minute)


##### Model Temporal Fit #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# Plot the two smoothers
plot(m.humid.ar1$gam, shade = T, residuals = T, ylab = "Humidity (% RH)", 
    main = "Woods Humid")

# Reset the layout
layout(1)


##### Transect Order #####

# Fit a model with transect order as a factor
m.humid.ar1.factor <- gamm(humidity ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + factor(order), 
    data = m.humid.data, correlation = corAR1(form = ~ 1|order))

# Fit a model with continuous transect order
m.humid.ar1.continuous <- gamm(humidity ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + order, 
    data = m.humid.data, correlation = corAR1(form = ~ 1|order))

# Test whether there are differences in humidity along the transect
AICctab(m.humid.uncorr$lme, m.humid.ar1$lme, m.humid.ar1.factor$lme, 
    m.humid.ar1.continuous$lme, nobs = nrow(m.humid.data))

# Show the summary for the transect order
summary(m.humid.ar1.factor$gam)
summary(m.humid.ar1.factor$lme)


```

### Woods Humidity

The model that includes transect order is worse than the base temporal model for woods humidity.

There are no significant differences between any of the transect positions for humidity in the woods.

```{r 'Woods_Humid', echo = F, comment = ""}

# Construct an uncorrelated gam with the two smoothers
w.humid.uncorr <- gamm(humidity ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = w.humid.data)

##### Autocorrelation #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(w.humid.uncorr$lme), lag.max = 96, main = "ACF")
pacf(resid(w.humid.uncorr$lme), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# ARMA Coefficients (non negative, default = 0)
# p = autoregressive order
# q = moving average order

# p = 1, q = 0 (AR1), grouped by order
w.humid.ar1 <- gamm(humidity ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = w.humid.data,
    correlation = corAR1(form = ~ 1|order))

# Compare models
AICctab(w.humid.uncorr$lme, w.humid.ar1$lme, nobs = nrow(w.humid.data))

# Show model summary
summary(w.humid.ar1$gam)

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(w.humid.ar1$lme, type = "normalized"), lag.max = 96, main = "ACF")
pacf(resid(w.humid.ar1$lme, type = "normalized"), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# Plot residuals over time
plot(w.humid.ar1$lme, resid(., type = "normalized") ~ minute)


##### Model Temporal Fit #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# Plot the two smoothers
plot(w.humid.ar1$gam, shade = T, residuals = T, ylab = "Humidity (% RH)", 
    main = "Woods Humid")

# Reset the layout
layout(1)


##### Transect Order #####

# Fit a model with transect order as a factor
w.humid.ar1.factor <- gamm(humidity ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + factor(order), 
    data = w.humid.data, correlation = corAR1(form = ~ 1|order))

# Fit a model with continuous transect order
w.humid.ar1.continuous <- gamm(humidity ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + order, 
    data = w.humid.data, correlation = corAR1(form = ~ 1|order))

# Test whether there are differences in humidity along the transect
AICctab(w.humid.uncorr$lme, w.humid.ar1$lme, w.humid.ar1.factor$lme, 
    w.humid.ar1.continuous$lme, nobs = nrow(w.humid.data))

# Show the summary for the transect order
summary(w.humid.ar1.factor$gam)
summary(w.humid.ar1.factor$lme)


```


## Volumetric Water Content

### Meadow VWC

The model that includes transect order as a continuous fixed factor is better than the base temporal model for meadow soil volumetric water content.  However, the base model is better than the model with transect order as a factor.  

The continuous model shows a positive trend towards increased soil moisture of about 0.039 m<sup>3</sup>/m<sup>3</sup> per position. This matches the pattern expected as the transect goes into the swamp.  

The factor model shows minimal differences between positions 1 and 2 (not significant).  However, position 3 is wetter, and position 4 is a lot wetter.  This is also what the data show, and qualitatively what one might expect.  

Also, an ANOVA shows that the factor model is better than the base temporal model, though AIC doesn't agree.  

```{r 'Meadow_VWC', echo = F, comment = ""}

# Construct an uncorrelated gam with the two smoothers
m.vwc.uncorr <- gamm(vwc ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = m.vwc.data)

##### Autocorrelation #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(m.vwc.uncorr$lme), lag.max = 96, main = "ACF")
pacf(resid(m.vwc.uncorr$lme), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# ARMA Coefficients (non negative, default = 0)
# p = autoregressive order
# q = moving average order

# p = 1, q = 0 (AR1), grouped by order
m.vwc.ar1 <- gamm(vwc ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = m.vwc.data,
    correlation = corAR1(form = ~ 1|order))

# Compare models
AICctab(m.vwc.uncorr$lme, m.vwc.ar1$lme, nobs = nrow(m.vwc.data))

# Show model summary
summary(m.vwc.ar1$gam)

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(m.vwc.ar1$lme, type = "normalized"), lag.max = 96, main = "ACF")
pacf(resid(m.vwc.ar1$lme, type = "normalized"), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# Plot residuals over time
plot(m.vwc.ar1$lme, resid(., type = "normalized") ~ minute)


##### Model Temporal Fit #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# Plot the two smoothers
plot(m.vwc.ar1$gam, shade = T, residuals = T, ylab = "VWC (m3/m3)", 
     main = "Meadow VWC")

# Reset the layout
layout(1)


##### Transect Order #####

# Fit a model with transect order as a factor
m.vwc.ar1.factor <- gamm(vwc ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + factor(order), 
    data = m.vwc.data, correlation = corAR1(form = ~ 1|order))

# Fit a model with continuous transect order
m.vwc.ar1.continuous <- gamm(vwc ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + order, 
    data = m.vwc.data, correlation = corAR1(form = ~ 1|order))

# Test whether there are differences in vwc along the transect
AICctab(m.vwc.uncorr$lme, m.vwc.ar1$lme, m.vwc.ar1.factor$lme, 
    m.vwc.ar1.continuous$lme, nobs = nrow(m.vwc.data))

# Show the summary for the transect order
summary(m.vwc.ar1.factor$gam)
summary(m.vwc.ar1.factor$lme)

# Show the summary for continuous transect order
summary(m.vwc.ar1.continuous$gam)
summary(m.vwc.ar1.continuous$lme)

# Likelihood ratio test/ANOVA shows that the factor model is better
anova(m.vwc.ar1$lme, m.vwc.ar1.factor$lme)

```

### Woods VWC

The model that includes transect order is better than the base temporal model for woods soil volumetric water content.  

The actual pattern is a bit odd, though it matches qualitative results.  The highest point on the hill (position 1) is the driest, while the second position is the wettest.  Position 3 is not different from position 2, and position 4 is intermediate between 1 and 2 in soil moisture.  

So, while there are differences among transect positions, there isn't really a gradient.

```{r 'Woods_VWC', echo = F, comment = ""}

# Construct an uncorrelated gam with the two smoothers
w.vwc.uncorr <- gamm(vwc ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = w.vwc.data)

##### Autocorrelation #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(w.vwc.uncorr$lme), lag.max = 96, main = "ACF")
pacf(resid(w.vwc.uncorr$lme), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# ARMA Coefficients (non negative, default = 0)
# p = autoregressive order
# q = moving average order

# p = 1, q = 0 (AR1), grouped by order
w.vwc.ar1 <- gamm(vwc ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), ctrl = list(niterEM = 0, optimMethod = "L-BFGS-B", 
    maxIter = 500, msMaxIter = 500), data = w.vwc.data,
    correlation = corAR1(form = ~ 1|order))

# Compare models
AICctab(w.vwc.uncorr$lme, w.vwc.ar1$lme, nobs = nrow(w.vwc.data))

# Show model summary
summary(w.vwc.ar1$gam)

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(w.vwc.ar1$lme, type = "normalized"), lag.max = 96, main = "ACF")
pacf(resid(w.vwc.ar1$lme, type = "normalized"), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# Plot residuals over time
plot(w.vwc.ar1$lme, resid(., type = "normalized") ~ minute)


##### Model Temporal Fit #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# Plot the two smoothers
plot(w.vwc.ar1$gam, shade = T, residuals = T, ylab = "VWC (m3/m3)", 
     main = "Woods VWC")

# Reset the layout
layout(1)


##### Transect Order #####

# Fit a model with transect order as a factor
w.vwc.ar1.factor <- gamm(vwc ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + factor(order), ctrl = list(niterEM = 0, optimMethod = "L-BFGS-B", 
    maxIter = 500, msMaxIter = 500), 
    data = w.vwc.data, correlation = corAR1(form = ~ 1|order))

# Fit a model with continuous transect order
# Error: doesn't run
#w.vwc.ar1.continuous <- gamm(vwc ~  s(day.min, bs = "cc", k = 96) + 
#    s(minute, k = 23, fx = T) + order, ctrl = list(niterEM = 0, optimMethod = "L-BFGS-B", 
#    maxIter = 1000, msMaxIter = 1000), 
#    data = w.vwc.data, correlation = corAR1(form = ~ 1|order))

# Test whether there are differences in vwc along the transect
AICctab(w.vwc.uncorr$lme, w.vwc.ar1$lme, w.vwc.ar1.factor$lme, 
    nobs = nrow(w.vwc.data))

# Show the summary for the transect order
summary(w.vwc.ar1.factor$gam)
summary(w.vwc.ar1.factor$lme)


```


## Photon Flux Density

### Meadow PFD

The model that includes transect order is better than the base temporal model for meadow PFD.  

There are no differences between positions 1 and 2, but 3 and 4 have increasingly lower PFD, with a maximum difference of 108 ยตmol/m<sup>2</sup>/s between position 2 and 4.  The difference between 1 and 3 is not significant (p = 0.08), but the difference between 1 and 4 is.  

This pattern can probably be explained by the increasing vegetation, especially in positions 3 and 4 that must be adding a small amount of shade.


```{r 'Meadow_PFD', echo = F, comment = ""}

# Construct an uncorrelated gam with the two smoothers
m.pfd.uncorr <- gamm(pfd ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = m.pfd.data)

##### Autocorrelation #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(m.pfd.uncorr$lme), lag.max = 96, main = "ACF")
pacf(resid(m.pfd.uncorr$lme), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# ARMA Coefficients (non negative, default = 0)
# p = autoregressive order
# q = moving average order

# p = 1, q = 0 (AR1), grouped by order
m.pfd.ar1 <- gamm(pfd ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = m.pfd.data,
    correlation = corAR1(form = ~ 1|order))

# Compare models
AICctab(m.pfd.uncorr$lme, m.pfd.ar1$lme, nobs = nrow(m.pfd.data))

# Show model summary
summary(m.pfd.ar1$gam)

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(m.pfd.ar1$lme, type = "normalized"), lag.max = 96, main = "ACF")
pacf(resid(m.pfd.ar1$lme, type = "normalized"), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# Plot residuals over time
plot(m.pfd.ar1$lme, resid(.) ~ minute)


##### Model Temporal Fit #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# Plot the two smoothers
plot(m.pfd.ar1$gam, shade = T, residuals = T, ylab = "PFD (ยตmol mโ2 sโ1)", 
     main = "Meadow PFD")

# Reset the layout
layout(1)


##### Transect Order #####

# Fit a model with transect order as a factor
m.pfd.ar1.factor <- gamm(pfd ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + factor(order), 
    data = m.pfd.data, correlation = corAR1(form = ~ 1|order))

# Fit a model with continuous transect order
m.pfd.ar1.continuous <- gamm(pfd ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + order, 
    data = m.pfd.data, correlation = corAR1(form = ~ 1|order))

# Test whether there are differences in pfd along the transect
AICctab(m.pfd.uncorr$lme, m.pfd.ar1$lme, m.pfd.ar1.factor$lme, 
    m.pfd.ar1.continuous$lme, nobs = nrow(m.pfd.data))

# Show the summary for the transect order
summary(m.pfd.ar1.factor$gam)
summary(m.pfd.ar1.factor$lme)



```

### Woods PFD

The model that includes transect order is better than the base temporal model for woods PFD.  

PFD increases from the highest position on the hill (position 1) to the bottom (position 4).  There are no significant differences between positions 1-3, but position 4 has significantly higher pfd, with a maximum difference of 18.7 ยตmol/m<sup>2</sup>/s between position 1 and 4.  

It's unclear what explains this difference. Perhaps light is coming from the forest edge?


```{r 'Woods_PFD', echo = F, comment = ""}
    
# Construct an uncorrelated gam with the two smoothers
w.pfd.uncorr <- gamm(pfd ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = w.pfd.data)

##### Autocorrelation #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(w.pfd.uncorr$lme), lag.max = 96, main = "ACF")
pacf(resid(w.pfd.uncorr$lme), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# ARMA Coefficients (non negative, default = 0)
# p = autoregressive order
# q = moving average order

# p = 1, q = 0 (AR1), grouped by order
w.pfd.ar1 <- gamm(pfd ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T), data = w.pfd.data,
    correlation = corAR1(form = ~ 1|order))

# Compare models
AICctab(w.pfd.uncorr$lme, w.pfd.ar1$lme, nobs = nrow(w.pfd.data))

# Show model summary
summary(w.pfd.ar1$gam)

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# plot of autocorrelation in variances
acf(resid(m.pfd.ar1$lme, type = "normalized"), lag.max = 96, main = "ACF")
pacf(resid(m.pfd.ar1$lme, type = "normalized"), lag.max = 96, main = "pACF")

# Reset the layout
layout(1)

# Plot residuals over time
plot(w.pfd.ar1$lme, resid(., type = "normalized") ~ minute)


##### Model Temporal Fit #####

# Set graphs to 1 row x 2 columns
layout(matrix(1:2, ncol = 2))

# Plot the two smoothers
plot(w.pfd.ar1$gam, shade = T, residuals = T, ylab = "PFD (ยตmol mโ2sโ1)", 
     main = "Woods PFD")

# Reset the layout
layout(1)


##### Transect Order #####

# Fit a model with transect order as a factor
w.pfd.ar1.factor <- gamm(pfd ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + factor(order), 
    data = w.pfd.data, correlation = corAR1(form = ~ 1|order))

# Fit a model with continuous transect order
w.pfd.ar1.continuous <- gamm(pfd ~  s(day.min, bs = "cc", k = 96) + 
    s(minute, k = 23, fx = T) + order, 
    data = w.pfd.data, correlation = corAR1(form = ~ 1|order))

# Test whether there are differences in pfd along the transect
AICctab(w.pfd.uncorr$lme, w.pfd.ar1$lme, w.pfd.ar1.factor$lme, 
    w.pfd.ar1.continuous$lme, nobs = nrow(w.pfd.data))

# Show the summary for the transect order
summary(w.pfd.ar1.factor$gam)
summary(w.pfd.ar1.factor$lme)


```


```{r 'within-transects plots', echo = F, comment = "", fig.height = 10, fig.width = 8}


# Extract the meadow transect temp coefficients & convert to data frame
mead.temp.df <- summary(m.temp.ar1.factor$gam)$p.table %>% data.frame %>%
    
    # Add columns
    mutate(
        
        # Mean for each transect position
        mean = ifelse(first(Estimate) == Estimate, Estimate, Estimate + first(Estimate)), 
        
        # The transect positions
        order = levels(as.factor(m.temp.data$order)),
        
        # Transect & variable
        var = "Temperature", transect = "Meadow", type = transect,      
        
        # Upper and lower standard errors
        upper = mean + Std..Error,
        lower = mean - Std..Error)
        
# Extract the woods transect temp coefficients & convert to data frame
wood.temp.df <- summary(w.temp.ar1.factor$gam)$p.table %>% data.frame %>%

    # Add columns
    mutate(
        
        # Mean for each transect position
        mean = ifelse(first(Estimate) == Estimate, Estimate, Estimate + first(Estimate)), 
        
        # The transect positions
        order = levels(as.factor(w.temp.data$order)),
        
        # Transect & variable
        var = "Temperature", transect = "Woods", type = transect,
        
        # Upper and lower standard errors
        upper = mean + Std..Error,
        lower = mean - Std..Error)

# Extract the meadow transect humid coefficients & convert to data frame
mead.humid.df <- summary(m.humid.ar1.factor$gam)$p.table %>% data.frame %>%
    
    # Add columns
    mutate(
        
        # Mean for each transect position
        mean = ifelse(first(Estimate) == Estimate, Estimate, Estimate + first(Estimate)), 
        
        # The transect positions
        order = levels(as.factor(m.humid.data$order)),
        
        # Transect & variable
        var = "Humidity", transect = "Meadow", type = transect,
        
        # Upper and lower standard errors
        upper = mean + Std..Error,
        lower = mean - Std..Error

        )
        
# Extract the woods transect humid coefficients & convert to data frame
wood.humid.df <- summary(w.humid.ar1.factor$gam)$p.table %>% data.frame %>%

    # Add columns
    mutate(
        
        # Mean for each transect position
        mean = ifelse(first(Estimate) == Estimate, Estimate, Estimate + first(Estimate)), 
        
        # The transect positions
        order = levels(as.factor(w.humid.data$order)),

        # Transect & variable
        var = "Humidity", transect = "Woods", type = transect,     
        
        # Upper and lower standard errors
        upper = mean + Std..Error,
        lower = mean - Std..Error

        )

# Extract the meadow transect vwc coefficients & convert to data frame
mead.vwc.df <- summary(m.vwc.ar1.factor$gam)$p.table %>% data.frame %>%
    
    # Add columns
    mutate(
        
        # Mean for each transect position
        mean = ifelse(first(Estimate) == Estimate, Estimate, Estimate + first(Estimate)), 
        
        # The transect positions
        order = levels(as.factor(m.vwc.data$order)),

        # Transect & variable
        var = "VWC", transect = "Meadow", type = transect,

        # Upper and lower standard errors
        upper = mean + Std..Error,
        lower = mean - Std..Error

        )
        
# Extract the woods transect vwc coefficients & convert to data frame
wood.vwc.df <- summary(w.vwc.ar1.factor$gam)$p.table %>% data.frame %>%

    # Add columns
    mutate(
        
        # Mean for each transect position
        mean = ifelse(first(Estimate) == Estimate, Estimate, Estimate + first(Estimate)), 
        
        # The transect positions
        order = levels(as.factor(w.vwc.data$order)),
        
        # Transect & variable
        var = "VWC", transect = "Woods", type = transect,
        
        # Upper and lower standard errors
        upper = mean + Std..Error,
        lower = mean - Std..Error

        )


# Extract the meadow transect pfd coefficients & convert to data frame
mead.pfd.df <- summary(m.pfd.ar1.factor$gam)$p.table %>% data.frame %>%
    
    # Add columns
    mutate(
        
        # Mean for each transect position
        mean = ifelse(first(Estimate) == Estimate, Estimate, Estimate + first(Estimate)), 
        
        # The transect positions
        order = levels(as.factor(m.pfd.data$order)),
        
        # Transect & variable
        var = "PFD", transect = "Meadow", type = transect,
        
        # Upper and lower standard errors
        upper = mean + Std..Error,
        lower = mean - Std..Error, 

        )
        
# Extract the woods transect pfd coefficients & convert to data frame
wood.pfd.df <- summary(w.pfd.ar1.factor$gam)$p.table %>% data.frame %>%

    # Add columns
    mutate(
        
        # Mean for each transect position
        mean = ifelse(first(Estimate) == Estimate, Estimate, Estimate + first(Estimate)), 
        
        # The transect positions
        order = levels(as.factor(w.pfd.data$order)),
        
        # Transect & variable
        var = "PFD", transect = "Woods", type = transect,
        
        # Upper and lower standard errors
        upper = mean + Std..Error,
        lower = mean - Std..Error

        )




# read in coefficients from the between transect model
between <- read.csv("Analyses/Fenton Hypotheses/transect.coeff.csv")

# Combine the between and within transect coefficients into one dataframe
combined.df <- between %>%
    
    # Add columns for upper, lower, mean, and (fake) transect order
    mutate(order = "5", 
           upper = Estimate + Std..Error,
           lower = Estimate - Std..Error, 
           mean = Estimate,
           type = paste("Between", transect)
           ) %>%
    
    # Reorder columns
    select(Estimate, Std..Error, t.value, Pr...t.., mean, order, 
        var, transect, type, upper, lower) %>%

    rbind(mead.temp.df, wood.temp.df, mead.humid.df, wood.humid.df, 
        mead.vwc.df, wood.vwc.df, mead.pfd.df, wood.pfd.df)


#combined.df


comb.temp.plot <- combined.df %>%
    
    # Filter to only include temperature
    filter(var == "Temperature") %>%
    
    # Plot 
    ggplot(aes(x = order, y = mean, color = transect)) +
    
        # Add points for the model coefficients at each transect position
        geom_point(size = 2) +
    
        # Add a line through the transect positions
        geom_line(aes(group = type), size = 1) +
        
        # Add standard error bars to the points
        geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +
        
        # Change the colors to red and blue for the two transects
        scale_color_manual(name = "Transect", values = c("red", "blue")) +
        
        # Add a dotted line between the within-transect coefficients and the between ones
        geom_vline(xintercept = 4.5, lty = 2) + 
    
        # Only show the four transect positions
        scale_x_discrete(breaks = 1:4) + 
    
        # Restrict X axis
        coord_cartesian(xlim = c(1, 4.55)) +  
        
        # Add axis labels
        xlab("EMU Number") + 
        ylab("Temperature") +
    
        # Add the custom theme
        ggplot.theme


comb.humid.plot <- combined.df %>%
    
    # Filter to only include humidity
    filter(var == "Humidity") %>%
    
    # Plot 
    ggplot(aes(x = order, y = mean, color = transect)) +
    
        # Add points for the model coefficients at each transect position
        geom_point(size = 2) +
    
        # Add a line through the transect positions
        geom_line(aes(group = type), size = 1) +
        
        # Add standard error bars to the points
        geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +
        
        # Change the colors to red and blue for the two transects
        scale_color_manual(name = "Transect", values = c("red", "blue")) +
        
        # Add a dotted line between the within-transect coefficients and the between ones
        geom_vline(xintercept = 4.5, lty = 2) + 
    
        # Only show the four transect positions
        scale_x_discrete(breaks = 1:4) + 
    
        # Restrict X axis
        coord_cartesian(xlim = c(1, 4.55)) +  
        
        # Add axis labels
        xlab("EMU Number") + 
        ylab("Relative Humidity") +
    
        # Add the custom theme
        ggplot.theme



comb.vwc.plot <- combined.df %>%
    
    # Filter to only include vwc
    filter(var == "VWC") %>%
    
    # Plot 
    ggplot(aes(x = order, y = mean, color = transect)) +
    
        # Add points for the model coefficients at each transect position
        geom_point(size = 2) +
    
        # Add a line through the transect positions
        geom_line(aes(group = type), size = 1) +
        
        # Add standard error bars to the points
        geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +
        
        # Change the colors to red and blue for the two transects
        scale_color_manual(name = "Transect", values = c("red", "blue")) +
        
        # Add a dotted line between the within-transect coefficients and the between ones
        geom_vline(xintercept = 4.5, lty = 2) + 
    
        # Only show the four transect positions
        scale_x_discrete(breaks = 1:4) + 
    
        # Restrict X axis
        coord_cartesian(xlim = c(1, 4.55)) +  
        
        # Add axis labels
        xlab("EMU Number") + 
        ylab("VWC") +
    
        # Add the custom theme
        ggplot.theme


comb.pfd.plot <- combined.df %>%
    
    # Filter to only include pfd
    filter(var == "PFD") %>%
    
    # Plot 
    ggplot(aes(x = order, y = mean, color = transect)) +
    
        # Add points for the model coefficients at each transect position
        geom_point(size = 2) +
    
        # Add a line through the transect positions
        geom_line(aes(group = type), size = 1) +
        
        # Add standard error bars to the points
        geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +
        
        # Change the colors to red and blue for the two transects
        scale_color_manual(name = "Transect", values = c("red", "blue")) +
        
        # Add a dotted line between the within-transect coefficients and the between ones
        geom_vline(xintercept = 4.5, lty = 2) + 
    
        # Only show the four transect positions
        scale_x_discrete(breaks = 1:4) + 
    
        # Restrict X axis
        coord_cartesian(xlim = c(1, 4.55)) +  
        
        # Add axis labels
        xlab("EMU Number") + 
        ylab("PFD") +
    
        # Add the custom theme
        ggplot.theme


g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

legend <- g_legend(comb.temp.plot)


plot_grid(
    comb.temp.plot + 
        theme(axis.text.x = element_blank(), axis.title.x = element_blank(), 
              legend.position="none"),  
        legend,
          
    comb.humid.plot + 
        theme(axis.text.x = element_blank(), axis.title.x = element_blank(), 
            legend.position="none"), 
          NULL,
          
    comb.vwc.plot + 
        theme(axis.text.x = element_blank(), axis.title.x = element_blank(), 
            legend.position="none"), 
          
          NULL,
          
    comb.pfd.plot + 
        theme(legend.position="none"), 
    
    ncol = 2, rel_widths = c(1, 0.2, 1, 0.2, 1, 0.2))




```

## Session Information

```{r 'Session_Info', echo = F, comment = ""}

# Add session information to help with reproduceability
sessionInfo()


```

